name: Build Electron App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest

    env:
      PYTHONIOENCODING: utf-8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        shell: pwsh
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
          echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Verify pnpm installation
        shell: pwsh
        run: |
          pnpm --version
          echo "pnpm is installed at: $(Get-Command pnpm | Select-Object -ExpandProperty Source)"

      - name: Get pnpm store directory
        shell: pwsh
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $env:GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Build application
        run: uv run python scripts/build_electron.py

      - name: List dist directory
        shell: pwsh
        run: |
          Get-ChildItem -Path electron\dist -Recurse -File | Select-Object FullName, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB, 2)}}

      - name: Get Windows artifact paths
        id: artifacts
        shell: pwsh
        run: |
          # Find portable exe (not containing "Setup")
          $portableExe = Get-ChildItem -Path electron\dist -Filter *.exe -File | Where-Object { $_.Name -notmatch "Setup" } | Select-Object -First 1
          if ($portableExe) {
            echo "portable_name=$($portableExe.Name -replace '\s', '-')" >> $env:GITHUB_OUTPUT
            echo "portable_path=$($portableExe.FullName)" >> $env:GITHUB_OUTPUT
            Write-Host "Found portable: $($portableExe.Name)"
          }

          # Find setup exe (containing "Setup")
          $setupExe = Get-ChildItem -Path electron\dist -Filter *.exe -File | Where-Object { $_.Name -match "Setup" } | Select-Object -First 1
          if ($setupExe) {
            echo "setup_name=$($setupExe.Name -replace '\s', '-')" >> $env:GITHUB_OUTPUT
            echo "setup_path=$($setupExe.FullName)" >> $env:GITHUB_OUTPUT
            Write-Host "Found setup: $($setupExe.Name)"
          }

          # Find blockmap
          $blockmap = Get-ChildItem -Path electron\dist -Filter *.exe.blockmap -File | Select-Object -First 1
          if ($blockmap) {
            echo "blockmap_name=$($blockmap.Name -replace '\s', '-')" >> $env:GITHUB_OUTPUT
            echo "blockmap_path=$($blockmap.FullName)" >> $env:GITHUB_OUTPUT
            Write-Host "Found blockmap: $($blockmap.Name)"
          }

      - name: Upload Windows portable EXE
        if: steps.artifacts.outputs.portable_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.portable_name }}
          path: ${{ steps.artifacts.outputs.portable_path }}
          retention-days: 7

      - name: Upload Windows setup EXE
        if: steps.artifacts.outputs.setup_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.setup_name }}
          path: ${{ steps.artifacts.outputs.setup_path }}
          retention-days: 7

      - name: Upload Windows setup blockmap
        if: steps.artifacts.outputs.blockmap_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.blockmap_name }}
          path: ${{ steps.artifacts.outputs.blockmap_path }}
          retention-days: 7

  build-macos:
    name: Build for macOS (ARM64)
    runs-on: macos-latest  # macOS ARM64 runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Verify pnpm installation
        run: |
          pnpm --version
          which pnpm

      - name: Get pnpm store directory
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Build application
        run: uv run python scripts/build_electron.py

      - name: List dist directory
        run: |
          ls -lh electron/dist/

      - name: Get macOS artifact paths
        id: artifacts
        run: |
          # Find DMG file (excluding blockmap)
          dmg_file=$(find electron/dist -type f -name "*.dmg" ! -name "*.blockmap" | head -n 1)
          if [ -n "$dmg_file" ]; then
            dmg_name=$(basename "$dmg_file" | tr ' ' '-')
            echo "dmg_name=$dmg_name" >> $GITHUB_OUTPUT
            echo "dmg_path=$dmg_file" >> $GITHUB_OUTPUT
            echo "Found DMG: $dmg_name"
          fi

          # Find blockmap file
          blockmap_file=$(find electron/dist -type f -name "*.dmg.blockmap" | head -n 1)
          if [ -n "$blockmap_file" ]; then
            blockmap_name=$(basename "$blockmap_file" | tr ' ' '-')
            echo "blockmap_name=$blockmap_name" >> $GITHUB_OUTPUT
            echo "blockmap_path=$blockmap_file" >> $GITHUB_OUTPUT
            echo "Found blockmap: $blockmap_name"
          fi

      - name: Upload macOS DMG
        if: steps.artifacts.outputs.dmg_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.dmg_name }}
          path: ${{ steps.artifacts.outputs.dmg_path }}
          retention-days: 7

      - name: Upload macOS blockmap
        if: steps.artifacts.outputs.blockmap_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.blockmap_name }}
          path: ${{ steps.artifacts.outputs.blockmap_path }}
          retention-days: 7

  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Verify pnpm installation
        run: |
          pnpm --version
          which pnpm

      - name: Get pnpm store directory
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Build application
        run: uv run python scripts/build_electron.py

      - name: List dist directory
        run: |
          ls -lh electron/dist/

      - name: Get Linux artifact paths
        id: artifacts
        run: |
          # Find AppImage file
          appimage_file=$(find electron/dist -type f -name "*.AppImage" | head -n 1)
          if [ -n "$appimage_file" ]; then
            appimage_name=$(basename "$appimage_file" | tr ' ' '-')
            echo "appimage_name=$appimage_name" >> $GITHUB_OUTPUT
            echo "appimage_path=$appimage_file" >> $GITHUB_OUTPUT
            echo "Found AppImage: $appimage_name"
          fi

          # Find deb file
          deb_file=$(find electron/dist -type f -name "*.deb" | head -n 1)
          if [ -n "$deb_file" ]; then
            deb_name=$(basename "$deb_file" | tr ' ' '-')
            echo "deb_name=$deb_name" >> $GITHUB_OUTPUT
            echo "deb_path=$deb_file" >> $GITHUB_OUTPUT
            echo "Found deb: $deb_name"
          fi

          # Find tar.gz file
          targz_file=$(find electron/dist -type f -name "*.tar.gz" | head -n 1)
          if [ -n "$targz_file" ]; then
            targz_name=$(basename "$targz_file" | tr ' ' '-')
            echo "targz_name=$targz_name" >> $GITHUB_OUTPUT
            echo "targz_path=$targz_file" >> $GITHUB_OUTPUT
            echo "Found tar.gz: $targz_name"
          fi

      - name: Upload Linux AppImage
        if: steps.artifacts.outputs.appimage_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.appimage_name }}
          path: ${{ steps.artifacts.outputs.appimage_path }}
          retention-days: 7

      - name: Upload Linux deb
        if: steps.artifacts.outputs.deb_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.deb_name }}
          path: ${{ steps.artifacts.outputs.deb_path }}
          retention-days: 7

      - name: Upload Linux tar.gz
        if: steps.artifacts.outputs.targz_name
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifacts.outputs.targz_name }}
          path: ${{ steps.artifacts.outputs.targz_path }}
          retention-days: 7

  # Summary job to check if all builds succeeded
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "Windows build: ${{ needs.build-windows.result }}"
          echo "macOS build: ${{ needs.build-macos.result }}"
          echo "Linux build: ${{ needs.build-linux.result }}"

          if [ "${{ needs.build-windows.result }}" != "success" ] || [ "${{ needs.build-macos.result }}" != "success" ] || [ "${{ needs.build-linux.result }}" != "success" ]; then
            echo "❌ Some builds failed"
            exit 1
          else
            echo "✅ All builds succeeded"
          fi
